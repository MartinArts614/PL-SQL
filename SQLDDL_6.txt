ALTER PROCEDURE [usrcon].[SOCIOS_ENV_CONC_ALNOVA_CAJAWU]
AS
SET NOCOUNT ON
SET IMPLICIT_TRANSACTIONS OFF

BEGIN TRY

 DECLARE @WU varchar(20) = 'WESTERN UNION'

 /* OBTENCION DE INFORMACION ALNOVA X PARAMETRIA */

 DECLARE @CONCILALN TABLE(
	FCALNSUCURSAL VARCHAR(50),
	FCALNOPECODIGO VARCHAR(50),
	FCALNFECHAOPE DATE,
	FCALNMONTO VARCHAR(50),
	FCALN071OBSERVA VARCHAR(50)
 )

 INSERT INTO @CONCILALN
	SELECT 
		D.T071_CEN_UPDATE,
		D.T071_CODE,
		D.T071_DAT_OPERATION,
		D.T071_AMOUNT, 
		SUBSTRING(D.T071_OBSERVATIONS, 5, 9) --TRANSACNUM
	FROM usrcon.PS_TTFYCAPTAALN_DATA_Sal D WITH(NOLOCK)
	INNER JOIN usrcon.WU_ENV_PARAM C WITH(NOLOCK) 
	ON C.FC_valida_Ent =D.T071_CODE
	AND C.FC_ACC = D.T071_ACC
	WHERE 
	FC_ESTATUS=1 AND
	FI_TIPO = 1 
	;

 /* CONCILIACION ALNOVA VS CAJA PARA WU */

 DECLARE @Cero  INT    = 0
 INSERT INTO usrcon.SOCIOS_ENV_TDWUCONCIL 
	 SELECT 
		A.FCALNSUCURSAL,
		B.FITRANNO,
		A.FCALNOPECODIGO,
		B.FCNOCAJERO,
		B.FCREFMOV,
		A.FCALNMONTO,
		a.FCALNFECHAOPE,
		'',
		@Cero,
		A.FCALN071OBSERVA,
		B.FCWORKSTATION,
		GETDATE()
	 FROM @CONCILALN A
	 INNER JOIN usrcon.PROC_TDMVTOCAJA B WITH(NOLOCK)
	 ON A.FCALNSUCURSAL = B.FISUCURSAL
	 AND A.FCALN071OBSERVA = SUBSTRING('000000000' + CONVERT(VARCHAR(50),B.FITRANNO), LEN('000000000' + CONVERT(VARCHAR(50),B.FITRANNO)) -8, 10) 
	 AND ABS (A.FCALNMONTO)= ABS (B.FNIMPMOV)
	 AND NOT EXISTS (SELECT top 1 'X' FROM usrcon.SOCIOS_ENV_TDWUCONCIL C WITH(NOLOCK) where C.FINOTRANSAC = B.FITRANNO) 
	 

	/*PENDIENTES ALNOVA*/
		 INSERT INTO usrcon.SOCIOS_ENV_PENDIENTES_TDWUCONCIL
			SELECT
			 FCALNSUCURSAL,
		'',
		FCALNOPECODIGO,
		'',
		'',
		FCALNMONTO,
		FCALNFECHAOPE,
		'',
		@Cero,
		FCALN071OBSERVA,
		'',
		GETDATE()
			FROM @CONCILALN A                                                             
			   WHERE CONVERT(VARCHAR(50), A.FCALN071OBSERVA) NOT IN (SELECT FITRANNO FROM usrcon.PROC_TDMVTOCAJA WJ) 
			    AND NOT EXISTS (SELECT top 1 'X' FROM usrcon.SOCIOS_ENV_PENDIENTES_TDWUCONCIL E WITH(NOLOCK) where E.FINOTRANSAC NOT IN (SELECT FITRANNO FROM usrcon.PROC_TDMVTOCAJA WJ))


	--PENDIENTES CAJA	

		INSERT INTO usrcon.SOCIOS_ENV_PENDIENTES_TDWUCONCIL
			SELECT 
			 '',
		FITRANNO,
		'',
		FCNOCAJERO,
		FCREFMOV,
		FNIMPMOV,
		convert(VARCHAR(50),FDMOVFECHR),
		'',
		0,
		'',
		FCWORKSTATION,
		GETDATE()
		FROM usrcon.PROC_TDMVTOCAJA WHERE CONVERT(VARCHAR(50), FITRANNO) NOT IN (SELECT T071_OBSERVATIONS FROM usrcon.SOCIOS_ENV_TDWUCONCIL WJ ) AND convert(DATETIME,'2023/10/03')=FDMOVFECHR
	 
END TRY

BEGIN CATCH
 DECLARE @FecHr	DATETIME = GETDATE()
 DECLARE @ERR AS VARCHAR(205)                                          
 SET @ERR = CONVERT(VARCHAR(205),ERROR_MESSAGE())                                          
 RAISERROR (@ERR,16,1)                                          
 INSERT INTO dbo.Conc_noc_error(T001_ENTIDAD,T001_PROCESO,T001_FEC_EJEC,T001_FEC_PROC,T001_FEC_PROX,ErrorNumber,ErrorSeverity,      
 ErrorState,ErrorProcedure,ErrorLine,ErrorMessage,fecha)            
 VALUES(127,'CCS',@FecHr,@FecHr,@FecHr,ERROR_NUMBER(),ERROR_SEVERITY(),ERROR_STATE(),ERROR_PROCEDURE(),ERROR_LINE(),ERROR_MESSAGE(),@FecHr)  

END CATCH


EXEC usrcon.SOCIOS_ENV_CONC_ALNOVA_CAJAWU;

SELECT * FROM usrcon.SOCIOS_ENV_PENDIENTES_TDWUCONCIL;

