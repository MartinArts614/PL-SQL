ALTER PROCEDURE [usrcon].[SP_CONCIL_ALNCAJA_OPEDEX]
AS
SET NOCOUNT ON
SET IMPLICIT_TRANSACTIONS OFF

BEGIN TRY

  WITH duplicates AS (
    SELECT NOM_PAIS_ORIG, NOM_PAIS_DEST, CLAVE_SUC_AGE_MVTO, MTCN, FECHA_TRANSC, MTO_ENVIO,
    MTO_ENVIO_USD, COMISION, NOM_AGEN_MVTO, NOM_SUBS_MTVO, TOTAL_IMPTO_MXP, MTO_RED, 
    FOLIO_AFECT, TC_TESO_PVP_PD, TIPO_CAMB,FNIMPMOV_CAJA, 
      ROW_NUMBER() OVER (PARTITION BY T071_OBSERVATIONS_ALN, FITRANNO_CAJA ORDER BY FCREFMOV_CAJA) AS row_num
    FROM usrcon.TC_ALNCAJA_CONCIL CON
    INNER JOIN usrcon.OP_DEX_TIPO_CAMBIO DEX
    ON CON.FCREFMOV_CAJA = DEX.MTCN

  )
  INSERT INTO usrcon.CONCIL_ALNCAJA_OPEDEX (NOM_PAIS_ORIG, NOM_PAIS_DEST, CLAVE_SUC_AGE_MVTO, MTCN, FECHA_TRANSC, MTO_ENVIO,
    MTO_ENVIO_USD, COMISION, NOM_AGEN_MVTO, NOM_SUBS_MTVO, TOTAL_IMPTO_MXP, MTO_RED, 
    FOLIO_AFECT, TC_TESO_PVP_PD, TIPO_CAMB,FNIMPMOV_CAJA)
    
  SELECT NOM_PAIS_ORIG, NOM_PAIS_DEST, CLAVE_SUC_AGE_MVTO, MTCN, FECHA_TRANSC, MTO_ENVIO,
    MTO_ENVIO_USD, COMISION, NOM_AGEN_MVTO, NOM_SUBS_MTVO, TOTAL_IMPTO_MXP, MTO_RED, 
    FOLIO_AFECT, TC_TESO_PVP_PD, TIPO_CAMB, FNIMPMOV_CAJA
  FROM duplicates
  WHERE row_num = 1
  
  END TRY
  
    BEGIN CATCH
 DECLARE @FecHr DATETIME = GETDATE()
 DECLARE @ERR AS VARCHAR(205)                                          
 SET @ERR = CONVERT(VARCHAR(205),ERROR_MESSAGE())                                          
 RAISERROR (@ERR,16,1)                                          
 INSERT INTO dbo.Conc_noc_error(T001_ENTIDAD,T001_PROCESO,T001_FEC_EJEC,T001_FEC_PROC,T001_FEC_PROX,ErrorNumber,ErrorSeverity,      
 ErrorState,ErrorProcedure,ErrorLine,ErrorMessage,fecha)            
 VALUES(127,'CCS',@FecHr,@FecHr,@FecHr,ERROR_NUMBER(),ERROR_SEVERITY(),ERROR_STATE(),ERROR_PROCEDURE(),ERROR_LINE(),ERROR_MESSAGE(),@FecHr)  

END CATCH;

SELECT NOM_PAIS_ORIG, NOM_PAIS_DEST, CLAVE_SUC_AGE_MVTO, MTCN, FECHA_TRANSC, MTO_ENVIO,
    MTO_ENVIO_USD, COMISION, NOM_AGEN_MVTO, NOM_SUBS_MTVO, TOTAL_IMPTO_MXP, MTO_RED, 
    FOLIO_AFECT, TC_TESO_PVP_PD, TIPO_CAMB,FNIMPMOV_CAJA 
     -- ROW_NUMBER() OVER (PARTITION BY T071_OBSERVATIONS_ALN, FITRANNO_CAJA ORDER BY FCREFMOV_CAJA) AS row_num
    FROM usrcon.TC_ALNCAJA_CONCIL CON
    INNER JOIN usrcon.OP_DEX_TIPO_CAMBIO DEX
    ON CON.FCREFMOV_CAJA = DEX.MTCN

SELECT * FROM usrcon.TC_ALNCAJA_CONCIL A
SELECT COUNT(*) FROM usrcon.TC_ALNCAJA_CONCIL A
where A.T071_OBSERVATIONS_ALN = A.FITRANNO_CAJA;

SELECT * FROM usrcon.TC_ALNCAJA_CONCIL A
JOIN usrcon.OP_DEX_TIPO_CAMBIO B
ON A.T071_OBSERVATIONS_ALN = B.MTCN ;

SELECT * FROM usrcon.TC_ALNCAJA_CONCIL A
JOIN usrcon.OP_DEX_TIPO_CAMBIO B
ON CONVERT(VARCHAR(20),A.FITRANNO_CAJA) = B.MTCN ;

SELECT * FROM usrcon.TC_ALNCAJA_CONCIL A
WHERE A.T071_OBSERVATIONS_ALN  = '41418662874';

SELECT * FROM usrcon.TC_ALNCAJA_CONCIL A
WHERE A.FITRANNO_CAJA  = '41418662874';

SELECT * FROM usrcon.OP_DEX_TIPO_CAMBIO A
WHERE A.MTCN  = '41418662874';

SELECT * FROM usrcon.CONCIL_ALNCAJA_OPEDEX A
WHERE A.MTCN = '41417331323';

SELECT * FROM usrcon.CONCIL_ALNCAJA_OPEDEX_TC A
WHERE A.MTCN = '41417331323';

SELECT * FROM usrcon.CONCIL_ALNCAJA_OPEDEX A
JOIN usrcon.CONCIL_ALNCAJA_OPEDEX_TC B
ON A.MTCN = B.MTCN ;

 FROM usrcon.CONCIL_ALNCAJA_OPEDEX CON
    INNER JOIN usrcon.TRANSACIONES_TIPO_CAMBIO TC

WITH duplicates AS (
SELECT B.NOM_PAIS_ORIG, B.NOM_PAIS_DEST, B.CLAVE_SUC_AGE_MVTO, B.MTCN, B.FECHA_TRANSC, B.MTO_ENVIO,
    B.MTO_ENVIO_USD, B.COMISION, B.NOM_AGEN_MVTO, B.NOM_SUBS_MTVO, B.TOTAL_IMPTO_MXP, B.MTO_RED, 
    B.FOLIO_AFECT, A.TC_TESO_PVP_PD, B.TIPO_CAMB, B.FNIMPMOV_CAJA,
ROW_NUMBER() OVER (PARTITION BY B.MTCN ORDER BY B.FECHA_TRANSC) AS row_num
FROM usrcon.CONCIL_ALNCAJA_OPEDEX A WITH(NOLOCK)
JOIN usrcon.CONCIL_ALNCAJA_OPEDEX_TC B ON A.MTCN = B.MTCN 
WHERE B.NOM_PAIS_ORIG = 'MEXICO'
AND  B.NOM_PAIS_DEST IN ('GUATEMALA','HONDURAS','PANAMA')
AND B.TIPO_CAMB_USD = A.TC_TESO_PVP_PD
)
SELECT COUNT(*)
FROM duplicates
WHERE row_num = 1;-- Son registros Ãºnicos

SELECT *
FROM usrcon.CONCIL_ALNCAJA_OPEDEX A
WHERE A.MTCN NOT IN (
  SELECT B.MTCN
  FROM usrcon.CONCIL_ALNCAJA_OPEDEX_TC B
); --- correcta

SELECT *
FROM usrcon.CONCIL_ALNCAJA_OPEDEX A
WHERE A.MTCN NOT IN (
  SELECT B.MTCN
  FROM usrcon.CONCIL_ALNCAJA_OPEDEX_TC B
  WHERE B.NOM_PAIS_ORIG = 'MEXICO'
  AND  B.NOM_PAIS_DEST IN ('GUATEMALA','HONDURAS','PANAMA')
  AND B.TIPO_CAMB_USD = A.TC_TESO_PVP_PD
);

SELECT DISTINCT *
FROM usrcon.CONCIL_ALNCAJA_OPEDEX A
WHERE A.MTCN NOT IN (
  SELECT B.MTCN
  FROM usrcon.CONCIL_ALNCAJA_OPEDEX_TC B
  WHERE B.NOM_PAIS_ORIG = 'MEXICO'
  AND  B.NOM_PAIS_DEST IN ('GUATEMALA','HONDURAS','PANAMA')
  AND B.TIPO_CAMB_USD = A.TC_TESO_PVP_PD
);

SELECT DISTINCT *
FROM usrcon.CONCIL_ALNCAJA_OPEDEX A
WHERE A.MTCN NOT IN (
  SELECT B.MTCN
  FROM usrcon.CONCIL_ALNCAJA_OPEDEX_TC B
);

SELECT COUNT(*) 
FROM usrcon.CONCIL_ALNCAJA_OPEDEX A WITH(NOLOCK);

SELECT COUNT(*) 
FROM usrcon.CONCIL_ALNCAJA_OPEDEX_TC B WITH(NOLOCK);

SELECT COUNT(*) 
FROM usrcon.CONCIL_ALNCAJA_OPEDEX A WITH(NOLOCK) 
JOIN usrcon.CONCIL_ALNCAJA_OPEDEX_TC B ON A.MTCN = B.MTCN 
JOIN usrcon.CONCIL_ALNCAJA_OPEDEX_TC C ON C.TIPO_CAMB_USD != A.TC_TESO_PVP_PD ;

  SELECT 
  D.pais AS origen_pais, 
  A.origen_valorEnvio,
  B.moneda AS moneda,
  E.pais AS destino_pais,
  A.destino_valorPago,
  C.moneda AS divisa
  FROM usrcon.TRANSACIONES_TIPO_CAMBIO A WITH(NOLOCK) 
  JOIN usrcon.TCMONEDAS_PAISES_TPCMB B ON A.origen_moneda  = B.idMoneda 
  JOIN usrcon.TCMONEDAS_PAISES_TPCMB C ON A.destino_moneda = C.idMoneda 
  JOIN usrcon.TCPAISES_TPCMB D ON A.origen_pais = D.idPais
  JOIN usrcon.TCPAISES_TPCMB E ON A.destino_pais = E.idPais 
  WHERE CONVERT(VARCHAR(10),A.fecha_operacion,121)>= @fecha_ini AND CONVERT(VARCHAR(10),A.fecha_operacion,121) <= @fecha_fin 
  AND D.pais = @origen_pais 
  AND E.pais = @destino_pais
  AND A.peticion_agente = @peticion_agente
  AND A.peticion_subsidiaria = @peticion_subsidiaria; 

------------ PRIMERA CONCILIACION ----------------------
EXEC usrcon.SP_CONCIL_ALNCAJA_OPEDEX;
SELECT * FROM usrcon.CONCIL_ALNCAJA_OPEDEX;
SELECT COUNT(*) FROM usrcon.CONCIL_ALNCAJA_OPEDEX; --- PRIMER RESULTADO

------------ SEGUNDA CONCILIACION ----------------------
EXEC usrcon.SP_CONCIL_ALNCAJA_OPEDEX_TC;
SELECT * FROM usrcon.CONCIL_ALNCAJA_OPEDEX_TC;
SELECT COUNT(*) FROM usrcon.CONCIL_ALNCAJA_OPEDEX_TC; --- SEGUNDO RESULTADO

TRUNCATE TABLE usrcon.OP_DEX_TIPO_CAMBIO;

SELECT * FROM usrcon.OP_DEX_TIPO_CAMBIO WHERE TC_TESO_PVP_PD IN ('.3752','.051');

SELECT * FROM usrcon.OP_DEX_TIPO_CAMBIO WHERE TC_TESO_PVP_PD IN ('7.8472','18.8189','0.3752','24.8596','1.2373','1','0.051') AND NOM_PAIS_ORIG = 'MEXICO' AND NOM_PAIS_DEST IN ('GUATEMALA','HONDURAS','PANAMA') ;

SELECT * FROM usrcon.TC_ALNCAJA_CONCIL;



SELECT NOM_PAIS_ORIG, NOM_PAIS_DEST, CLAVE_SUC_AGE_MVTO, MTCN, FECHA_TRANSC, MTO_ENVIO,
    MTO_ENVIO_USD, COMISION, NOM_AGEN_MVTO, NOM_SUBS_MTVO, TOTAL_IMPTO_MXP, MTO_RED, 
    FOLIO_AFECT, TC_TESO_PVP_PD, TIPO_CAMB,FNIMPMOV_CAJA
    --ROW_NUMBER() OVER (PARTITION BY MTCN ORDER BY FECHA_TRANSC) AS row_num
    FROM usrcon.CONCIL_ALNCAJA_OPEDEX CON
    INNER JOIN usrcon.TRANSACIONES_TIPO_CAMBIO TC
    ON CON.TC_TESO_PVP_PD = TC.destino_valorPago
    WHERE NOM_PAIS_ORIG = 'MEXICO'
    AND  NOM_PAIS_DEST IN ('GUATEMALA','HONDURAS','PANAMA');



